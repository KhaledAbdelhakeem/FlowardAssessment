"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.configureBinaryLog = configureBinaryLog;
exports.getNpmPackageInfo = getNpmPackageInfo;
exports.inquirer = void 0;
exports.nok = nok;
exports.nokOptional = nokOptional;
exports.ok = ok;
exports.okOptional = okOptional;
exports.resetLog = resetLog;
exports.resolveExecutablePath = resolveExecutablePath;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _inquirer2 = _interopRequireDefault(require("inquirer"));

var _logger = _interopRequireDefault(require("../lib/logger"));

var _support = require("@appium/support");

var _teen_process = require("teen_process");

var _lodash = require("lodash");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ok(message) {
  return {
    ok: true,
    optional: false,
    message
  };
}

function nok(message) {
  return {
    ok: false,
    optional: false,
    message
  };
}

function okOptional(message) {
  return {
    ok: true,
    optional: true,
    message
  };
}

function nokOptional(message) {
  return {
    ok: false,
    optional: true,
    message
  };
}

const inquirer = {
  prompt: _bluebird.default.promisify(function (question, cb) {
    _inquirer2.default.prompt(question, function (resp) {
      cb(null, resp);
    });
  })
};
exports.inquirer = inquirer;
let actualLog;

function configureBinaryLog(opts) {
  actualLog = _logger.default.unwrap().log;

  _logger.default.unwrap().log = function (level, prefix, msg) {
    let l = this.levels[level];
    if (l < this.levels[this.level]) return;
    actualLog(level, prefix, msg);

    if ((0, _lodash.isFunction)(opts.onLogMessage)) {
      opts.onLogMessage(level, prefix, msg);
    }
  };

  _logger.default.level = opts.debug ? 'debug' : 'info';
}

function resetLog() {
  if (actualLog) {
    _logger.default.unwrap().log = actualLog;
  }
}

async function resolveExecutablePath(cmd) {
  let executablePath;

  try {
    executablePath = await _support.fs.which(cmd);

    if (executablePath && (await _support.fs.exists(executablePath))) {
      return executablePath;
    }
  } catch (err) {
    if (/not found/gi.test(err.message)) {
      _logger.default.debug(err);
    } else {
      _logger.default.warn(err);
    }
  }

  _logger.default.debug(`No executable path of '${cmd}'.`);

  if (executablePath) {
    _logger.default.debug(`Does '${executablePath}' exist?`);
  }

  return null;
}

async function getNpmPackageInfo(packageName) {
  const npmPath = await resolveExecutablePath(`npm${_support.system.isWindows() ? `.cmd` : ''}`);

  if (!npmPath) {
    return nokOptional(`'npm' binary not found in PATH: ${process.env.PATH}`);
  }

  let pJson = {};

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)(npmPath, ['list', '-g', '-l', '-j', packageName]);
    pJson = JSON.parse(stdout);
  } catch (err) {
    _logger.default.debug(err);

    return null;
  }

  if (pJson.dependencies && pJson.dependencies[packageName]) {
    return {
      version: pJson.dependencies[packageName].version,
      path: pJson.path
    };
  }

  return null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJvayIsIm1lc3NhZ2UiLCJvcHRpb25hbCIsIm5vayIsIm9rT3B0aW9uYWwiLCJub2tPcHRpb25hbCIsImlucXVpcmVyIiwicHJvbXB0IiwiQiIsInByb21pc2lmeSIsInF1ZXN0aW9uIiwiY2IiLCJfaW5xdWlyZXIiLCJyZXNwIiwiYWN0dWFsTG9nIiwiY29uZmlndXJlQmluYXJ5TG9nIiwib3B0cyIsImxvZyIsInVud3JhcCIsImxldmVsIiwicHJlZml4IiwibXNnIiwibCIsImxldmVscyIsImlzRnVuY3Rpb24iLCJvbkxvZ01lc3NhZ2UiLCJkZWJ1ZyIsInJlc2V0TG9nIiwicmVzb2x2ZUV4ZWN1dGFibGVQYXRoIiwiY21kIiwiZXhlY3V0YWJsZVBhdGgiLCJmcyIsIndoaWNoIiwiZXhpc3RzIiwiZXJyIiwidGVzdCIsIndhcm4iLCJnZXROcG1QYWNrYWdlSW5mbyIsInBhY2thZ2VOYW1lIiwibnBtUGF0aCIsInN5c3RlbSIsImlzV2luZG93cyIsInByb2Nlc3MiLCJlbnYiLCJQQVRIIiwicEpzb24iLCJzdGRvdXQiLCJleGVjIiwiSlNPTiIsInBhcnNlIiwiZGVwZW5kZW5jaWVzIiwidmVyc2lvbiIsInBhdGgiXSwic291cmNlcyI6WyIuLi8uLi9saWIvdXRpbHMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF9pbnF1aXJlciBmcm9tICdpbnF1aXJlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xpYi9sb2dnZXInO1xuaW1wb3J0IHtmcywgc3lzdGVtfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHtleGVjfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHtpc0Z1bmN0aW9ufSBmcm9tICdsb2Rhc2gnO1xuXG5mdW5jdGlvbiBvayhtZXNzYWdlKSB7XG4gIHJldHVybiB7b2s6IHRydWUsIG9wdGlvbmFsOiBmYWxzZSwgbWVzc2FnZX07XG59XG5mdW5jdGlvbiBub2sobWVzc2FnZSkge1xuICByZXR1cm4ge29rOiBmYWxzZSwgb3B0aW9uYWw6IGZhbHNlLCBtZXNzYWdlfTtcbn1cbmZ1bmN0aW9uIG9rT3B0aW9uYWwobWVzc2FnZSkge1xuICByZXR1cm4ge29rOiB0cnVlLCBvcHRpb25hbDogdHJ1ZSwgbWVzc2FnZX07XG59XG5mdW5jdGlvbiBub2tPcHRpb25hbChtZXNzYWdlKSB7XG4gIHJldHVybiB7b2s6IGZhbHNlLCBvcHRpb25hbDogdHJ1ZSwgbWVzc2FnZX07XG59XG5cbmNvbnN0IGlucXVpcmVyID0ge1xuICBwcm9tcHQ6IEIucHJvbWlzaWZ5KGZ1bmN0aW9uIChxdWVzdGlvbiwgY2IpIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrc1xuICAgIF9pbnF1aXJlci5wcm9tcHQocXVlc3Rpb24sIGZ1bmN0aW9uIChyZXNwKSB7XG4gICAgICBjYihudWxsLCByZXNwKTtcbiAgICB9KTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgfSksXG59O1xuXG5sZXQgYWN0dWFsTG9nO1xuXG5mdW5jdGlvbiBjb25maWd1cmVCaW5hcnlMb2cob3B0cykge1xuICBhY3R1YWxMb2cgPSBsb2cudW53cmFwKCkubG9nO1xuICBsb2cudW53cmFwKCkubG9nID0gZnVuY3Rpb24gKGxldmVsLCBwcmVmaXgsIG1zZykge1xuICAgIGxldCBsID0gdGhpcy5sZXZlbHNbbGV2ZWxdO1xuICAgIGlmIChsIDwgdGhpcy5sZXZlbHNbdGhpcy5sZXZlbF0pIHJldHVybjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgIGFjdHVhbExvZyhsZXZlbCwgcHJlZml4LCBtc2cpO1xuXG4gICAgaWYgKGlzRnVuY3Rpb24ob3B0cy5vbkxvZ01lc3NhZ2UpKSB7XG4gICAgICBvcHRzLm9uTG9nTWVzc2FnZShsZXZlbCwgcHJlZml4LCBtc2cpO1xuICAgIH1cbiAgfTtcbiAgbG9nLmxldmVsID0gb3B0cy5kZWJ1ZyA/ICdkZWJ1ZycgOiAnaW5mbyc7XG59XG5cbi8qKlxuICogSWYge0BsaW5rIGNvbmZpZ3VyZUJpbmFyeUxvZ30gd2FzIGNhbGxlZCwgdGhpcyB3aWxsIHJlc3RvcmUgdGhlIG9yaWdpbmFsIGBsb2dgIGZ1bmN0aW9uLlxuICovXG5mdW5jdGlvbiByZXNldExvZygpIHtcbiAgaWYgKGFjdHVhbExvZykge1xuICAgIGxvZy51bndyYXAoKS5sb2cgPSBhY3R1YWxMb2c7XG4gIH1cbn1cblxuLyoqXG4gKiBSZXR1cm4gYW4gZXhlY3V0YWJsZSBwYXRoIG9mIGNtZFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBjbWQgU3RhbmRhcmQgb3V0cHV0IGJ5IGNvbW1hbmRcbiAqIEByZXR1cm4gez9zdHJpbmd9IFRoZSBmdWxsIHBhdGggb2YgY21kLiBgbnVsbGAgaWYgdGhlIGNtZCBpcyBub3QgZm91bmQuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHJlc29sdmVFeGVjdXRhYmxlUGF0aChjbWQpIHtcbiAgbGV0IGV4ZWN1dGFibGVQYXRoO1xuICB0cnkge1xuICAgIGV4ZWN1dGFibGVQYXRoID0gYXdhaXQgZnMud2hpY2goY21kKTtcbiAgICBpZiAoZXhlY3V0YWJsZVBhdGggJiYgKGF3YWl0IGZzLmV4aXN0cyhleGVjdXRhYmxlUGF0aCkpKSB7XG4gICAgICByZXR1cm4gZXhlY3V0YWJsZVBhdGg7XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoL25vdCBmb3VuZC9naS50ZXN0KGVyci5tZXNzYWdlKSkge1xuICAgICAgbG9nLmRlYnVnKGVycik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy53YXJuKGVycik7XG4gICAgfVxuICB9XG4gIGxvZy5kZWJ1ZyhgTm8gZXhlY3V0YWJsZSBwYXRoIG9mICcke2NtZH0nLmApO1xuICBpZiAoZXhlY3V0YWJsZVBhdGgpIHtcbiAgICBsb2cuZGVidWcoYERvZXMgJyR7ZXhlY3V0YWJsZVBhdGh9JyBleGlzdD9gKTtcbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiBOcG1QYWNrYWdlSW5mb1xuICogQHByb3BlcnR5IHtzdHJpbmd9IHZlcnNpb24gLSB2ZXJzaW9uXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGF0aCAtIEEgcGF0aCB0byBucG0gcm9vdFxuICovXG4vKipcbiAqIFJldHVybnMgdGhlIHBhdGggYW5kIHZlcnNpb24gb2YgZ2l2ZW4gcGFja2FnZSBuYW1lXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFja2FnZU5hbWUgQSBwYWNrYWdlIG5hbWUgdG8gZ2V0IHBhdGggYW5kIHZlcnNpb24gZGF0YVxuICogQHJldHVybiB7P05wbVBhY2thZ2VJbmZvfVxuICovXG5hc3luYyBmdW5jdGlvbiBnZXROcG1QYWNrYWdlSW5mbyhwYWNrYWdlTmFtZSkge1xuICBjb25zdCBucG1QYXRoID0gYXdhaXQgcmVzb2x2ZUV4ZWN1dGFibGVQYXRoKGBucG0ke3N5c3RlbS5pc1dpbmRvd3MoKSA/IGAuY21kYCA6ICcnfWApO1xuICBpZiAoIW5wbVBhdGgpIHtcbiAgICByZXR1cm4gbm9rT3B0aW9uYWwoYCducG0nIGJpbmFyeSBub3QgZm91bmQgaW4gUEFUSDogJHtwcm9jZXNzLmVudi5QQVRIfWApO1xuICB9XG5cbiAgbGV0IHBKc29uID0ge307XG4gIHRyeSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKG5wbVBhdGgsIFsnbGlzdCcsICctZycsICctbCcsICctaicsIHBhY2thZ2VOYW1lXSk7XG4gICAgcEpzb24gPSBKU09OLnBhcnNlKHN0ZG91dCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhlcnIpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgaWYgKHBKc29uLmRlcGVuZGVuY2llcyAmJiBwSnNvbi5kZXBlbmRlbmNpZXNbcGFja2FnZU5hbWVdKSB7XG4gICAgcmV0dXJuIHt2ZXJzaW9uOiBwSnNvbi5kZXBlbmRlbmNpZXNbcGFja2FnZU5hbWVdLnZlcnNpb24sIHBhdGg6IHBKc29uLnBhdGh9O1xuICB9XG5cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCB7XG4gIG9rLFxuICBub2ssXG4gIG9rT3B0aW9uYWwsXG4gIG5va09wdGlvbmFsLFxuICBpbnF1aXJlcixcbiAgY29uZmlndXJlQmluYXJ5TG9nLFxuICByZXNvbHZlRXhlY3V0YWJsZVBhdGgsXG4gIGdldE5wbVBhY2thZ2VJbmZvLFxuICByZXNldExvZyxcbn07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxTQUFTQSxFQUFULENBQVlDLE9BQVosRUFBcUI7RUFDbkIsT0FBTztJQUFDRCxFQUFFLEVBQUUsSUFBTDtJQUFXRSxRQUFRLEVBQUUsS0FBckI7SUFBNEJEO0VBQTVCLENBQVA7QUFDRDs7QUFDRCxTQUFTRSxHQUFULENBQWFGLE9BQWIsRUFBc0I7RUFDcEIsT0FBTztJQUFDRCxFQUFFLEVBQUUsS0FBTDtJQUFZRSxRQUFRLEVBQUUsS0FBdEI7SUFBNkJEO0VBQTdCLENBQVA7QUFDRDs7QUFDRCxTQUFTRyxVQUFULENBQW9CSCxPQUFwQixFQUE2QjtFQUMzQixPQUFPO0lBQUNELEVBQUUsRUFBRSxJQUFMO0lBQVdFLFFBQVEsRUFBRSxJQUFyQjtJQUEyQkQ7RUFBM0IsQ0FBUDtBQUNEOztBQUNELFNBQVNJLFdBQVQsQ0FBcUJKLE9BQXJCLEVBQThCO0VBQzVCLE9BQU87SUFBQ0QsRUFBRSxFQUFFLEtBQUw7SUFBWUUsUUFBUSxFQUFFLElBQXRCO0lBQTRCRDtFQUE1QixDQUFQO0FBQ0Q7O0FBRUQsTUFBTUssUUFBUSxHQUFHO0VBQ2ZDLE1BQU0sRUFBRUMsaUJBQUEsQ0FBRUMsU0FBRixDQUFZLFVBQVVDLFFBQVYsRUFBb0JDLEVBQXBCLEVBQXdCO0lBRTFDQyxrQkFBQSxDQUFVTCxNQUFWLENBQWlCRyxRQUFqQixFQUEyQixVQUFVRyxJQUFWLEVBQWdCO01BQ3pDRixFQUFFLENBQUMsSUFBRCxF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