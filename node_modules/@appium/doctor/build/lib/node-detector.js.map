{"version":3,"file":"node-detector.js","names":["NODE_COMMON_PATHS","process","env","NODE_BIN","NodeDetector","retrieveInCommonPlaces","p","fs","exists","log","debug","retrieveUsingSystemCall","nodePath","resolveExecutablePath","PATH","retrieveUsingAppleScript","system","isMac","appScript","join","stdout","exec","err","replace","retrieveUsingAppiumConfigFile","jsonobj","appiumConfigPath","path","resolve","__dirname","JSON","parse","readFile","node_bin","detect","warn"],"sources":["../../lib/node-detector.js"],"sourcesContent":["import {fs, system} from '@appium/support';\nimport {exec} from 'teen_process';\nimport log from './logger';\nimport path from 'path';\nimport {resolveExecutablePath} from './utils';\n\nconst NODE_COMMON_PATHS = [process.env.NODE_BIN, '/usr/local/bin/node', '/opt/local/bin/node'];\n\n// Look for node\nclass NodeDetector {\n  static async retrieveInCommonPlaces() {\n    for (let p of NODE_COMMON_PATHS) {\n      if (p && (await fs.exists(p))) {\n        log.debug(`Node binary found at common place: ${p}`);\n        return p;\n      }\n    }\n    log.debug(\"Node binary wasn't found at common places.\");\n    return null;\n  }\n\n  static async retrieveUsingSystemCall() {\n    const nodePath = await resolveExecutablePath('node');\n\n    if (!nodePath) {\n      log.debug(`Node binary not found in PATH: ${process.env.PATH}`);\n      return null;\n    }\n\n    log.debug(`Node binary found at: ${nodePath}`);\n    return nodePath;\n  }\n\n  static async retrieveUsingAppleScript() {\n    if (!system.isMac()) {\n      log.debug('Not on Darwin, skipping Apple Script');\n      return null;\n    }\n\n    const appScript = [\n      'try',\n      '  set appiumIsRunning to false',\n      '  tell application \"System Events\"',\n      '    set appiumIsRunning to name of every process contains \"Appium\"',\n      '  end tell',\n      '  if appiumIsRunning then',\n      '    tell application \"Appium\" to return node path',\n      '  end if',\n      'end try',\n      'return \"NULL\"',\n    ].join('\\n');\n    let stdout;\n    try {\n      stdout = (await exec('osascript', ['-e', appScript])).stdout;\n    } catch (err) {\n      log.debug(err);\n      return null;\n    }\n    let nodePath = stdout.replace('\\n', '');\n    if (await fs.exists(nodePath)) {\n      log.debug(`Node binary found using AppleScript at: ${nodePath}`);\n      return nodePath;\n    } else {\n      log.debug('Node binary not found using AppleScript.');\n      return null;\n    }\n  }\n\n  static async retrieveUsingAppiumConfigFile() {\n    let jsonobj;\n    try {\n      const appiumConfigPath = path.resolve(__dirname, '..', '..', '.appiumconfig.json');\n      if (await fs.exists(appiumConfigPath)) {\n        jsonobj = JSON.parse(await fs.readFile(appiumConfigPath, 'utf8'));\n      }\n    } catch (err) {\n      log.debug(err);\n      return null;\n    }\n    if (jsonobj && jsonobj.node_bin && (await fs.exists(jsonobj.node_bin))) {\n      log.debug(`Node binary found using .appiumconfig.json at: ${jsonobj.node_bin}`);\n      return jsonobj.node_bin;\n    } else {\n      log.debug('Node binary not found in the .appiumconfig.json file.');\n      return null;\n    }\n  }\n\n  static async detect() {\n    let nodePath =\n      (await NodeDetector.retrieveUsingSystemCall()) ||\n      (await NodeDetector.retrieveInCommonPlaces()) ||\n      (await NodeDetector.retrieveUsingAppleScript()) ||\n      (await NodeDetector.retrieveUsingAppiumConfigFile());\n    if (nodePath) {\n      return nodePath;\n    } else {\n      log.warn('The node binary could not be found.');\n      return null;\n    }\n  }\n}\n\nexport default NodeDetector;\n"],"mappings":";;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;;;AAEA,MAAMA,iBAAiB,GAAG,CAACC,OAAO,CAACC,GAAR,CAAYC,QAAb,EAAuB,qBAAvB,EAA8C,qBAA9C,CAA1B;;AAGA,MAAMC,YAAN,CAAmB;EACkB,aAAtBC,sBAAsB,GAAG;IACpC,KAAK,IAAIC,CAAT,IAAcN,iBAAd,EAAiC;MAC/B,IAAIM,CAAC,KAAK,MAAMC,WAAA,CAAGC,MAAH,CAAUF,CAAV,CAAX,CAAL,EAA+B;QAC7BG,eAAA,CAAIC,KAAJ,CAAW,sCAAqCJ,CAAE,EAAlD;;QACA,OAAOA,CAAP;MACD;IACF;;IACDG,eAAA,CAAIC,KAAJ,CAAU,4CAAV;;IACA,OAAO,IAAP;EACD;;EAEmC,aAAvBC,uBAAuB,GAAG;IACrC,MAAMC,QAAQ,GAAG,MAAM,IAAAC,4BAAA,EAAsB,MAAtB,CAAvB;;IAEA,IAAI,CAACD,QAAL,EAAe;MACbH,eAAA,CAAIC,KAAJ,CAAW,kCAAiCT,OAAO,CAACC,GAAR,CAAYY,IAAK,EAA7D;;MACA,OAAO,IAAP;IACD;;IAEDL,eAAA,CAAIC,KAAJ,CAAW,yBAAwBE,QAAS,EAA5C;;IACA,OAAOA,QAAP;EACD;;EAEoC,aAAxBG,wBAAwB,GAAG;IACtC,IAAI,CAACC,eAAA,CAAOC,KAAP,EAAL,EAAqB;MACnBR,eAAA,CAAIC,KAAJ,CAAU,sCAAV;;MACA,OAAO,IAAP;IACD;;IAED,MAAMQ,SAAS,GAAG,CAChB,KADgB,EAEhB,gCAFgB,EAGhB,oCAHgB,EAIhB,oEAJgB,EAKhB,YALgB,EAMhB,2BANgB,EAOhB,mDAPgB,EAQhB,UARgB,EAShB,SATgB,EAUhB,eAVgB,EAWhBC,IAXgB,CAWX,IAXW,CAAlB;IAYA,IAAIC,MAAJ;;IACA,IAAI;MACFA,MAAM,GAAG,CAAC,MAAM,IAAAC,kBAAA,EAAK,WAAL,EAAkB,CAAC,IAAD,EAAOH,SAAP,CAAlB,CAAP,EAA6CE,MAAtD;IACD,CAFD,CAEE,OAAOE,GAAP,EAAY;MACZb,eAAA,CAAIC,KAAJ,CAAUY,GAAV;;MACA,OAAO,IAAP;IACD;;IACD,IAAIV,QAAQ,GAAGQ,MAAM,CAACG,OAAP,CAAe,IAAf,EAAqB,EAArB,CAAf;;IACA,IAAI,MAAMhB,WAAA,CAAGC,MAAH,CAAUI,QAAV,CAAV,EAA+B;MAC7BH,eAAA,CAAIC,KAAJ,CAAW,2CAA0CE,QAAS,EAA9D;;MACA,OAAOA,QAAP;IACD,CAHD,MAGO;MACLH,eAAA,CAAIC,KAAJ,CAAU,0CAAV;;MACA,OAAO,IAAP;IACD;EACF;;EAEyC,aAA7Bc,6BAA6B,GAAG;IAC3C,IAAIC,OAAJ;;IACA,IAAI;MACF,MAAMC,gBAAgB,GAAGC,aAAA,CAAKC,OAAL,CAAaC,SAAb,EAAwB,IAAxB,EAA8B,IAA9B,EAAoC,oBAApC,CAAzB;;MACA,IAAI,MAAMtB,WAAA,CAAGC,MAAH,CAAUkB,gBAAV,CAAV,EAAuC;QACrCD,OAAO,GAAGK,IAAI,CAACC,KAAL,CAAW,MAAMxB,WAAA,CAAGyB,QAAH,CAAYN,gBAAZ,EAA8B,MAA9B,CAAjB,CAAV;MACD;IACF,CALD,CAKE,OAAOJ,GAAP,EAAY;MACZb,eAAA,CAAIC,KAAJ,CAAUY,GAAV;;MACA,OAAO,IAAP;IACD;;IACD,IAAIG,OAAO,IAAIA,OAAO,CAACQ,QAAnB,KAAgC,MAAM1B,WAAA,CAAGC,MAAH,CAAUiB,OAAO,CAACQ,QAAlB,CAAtC,CAAJ,EAAwE;MACtExB,eAAA,CAAIC,KAAJ,CAAW,kDAAiDe,OAAO,CAACQ,QAAS,EAA7E;;MACA,OAAOR,OAAO,CAACQ,QAAf;IACD,CAHD,MAGO;MACLxB,eAAA,CAAIC,KAAJ,CAAU,uDAAV;;MACA,OAAO,IAAP;IACD;EACF;;EAEkB,aAANwB,MAAM,GAAG;IACpB,IAAItB,QAAQ,GACV,CAAC,MAAMR,YAAY,CAACO,uBAAb,EAAP,MACC,MAAMP,YAAY,CAACC,sBAAb,EADP,MAEC,MAAMD,YAAY,CAACW,wBAAb,EAFP,MAGC,MAAMX,YAAY,CAACoB,6BAAb,EAHP,CADF;;IAKA,IAAIZ,QAAJ,EAAc;MACZ,OAAOA,QAAP;IACD,CAFD,MAEO;MACLH,eAAA,CAAI0B,IAAJ,CAAS,qCAAT;;MACA,OAAO,IAAP;IACD;EACF;;AA3FgB;;eA8FJ/B,Y"}