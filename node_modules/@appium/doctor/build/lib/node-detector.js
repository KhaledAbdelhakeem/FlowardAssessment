"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _support = require("@appium/support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const NODE_COMMON_PATHS = [process.env.NODE_BIN, '/usr/local/bin/node', '/opt/local/bin/node'];

class NodeDetector {
  static async retrieveInCommonPlaces() {
    for (let p of NODE_COMMON_PATHS) {
      if (p && (await _support.fs.exists(p))) {
        _logger.default.debug(`Node binary found at common place: ${p}`);

        return p;
      }
    }

    _logger.default.debug("Node binary wasn't found at common places.");

    return null;
  }

  static async retrieveUsingSystemCall() {
    const nodePath = await (0, _utils.resolveExecutablePath)('node');

    if (!nodePath) {
      _logger.default.debug(`Node binary not found in PATH: ${process.env.PATH}`);

      return null;
    }

    _logger.default.debug(`Node binary found at: ${nodePath}`);

    return nodePath;
  }

  static async retrieveUsingAppleScript() {
    if (!_support.system.isMac()) {
      _logger.default.debug('Not on Darwin, skipping Apple Script');

      return null;
    }

    const appScript = ['try', '  set appiumIsRunning to false', '  tell application "System Events"', '    set appiumIsRunning to name of every process contains "Appium"', '  end tell', '  if appiumIsRunning then', '    tell application "Appium" to return node path', '  end if', 'end try', 'return "NULL"'].join('\n');
    let stdout;

    try {
      stdout = (await (0, _teen_process.exec)('osascript', ['-e', appScript])).stdout;
    } catch (err) {
      _logger.default.debug(err);

      return null;
    }

    let nodePath = stdout.replace('\n', '');

    if (await _support.fs.exists(nodePath)) {
      _logger.default.debug(`Node binary found using AppleScript at: ${nodePath}`);

      return nodePath;
    } else {
      _logger.default.debug('Node binary not found using AppleScript.');

      return null;
    }
  }

  static async retrieveUsingAppiumConfigFile() {
    let jsonobj;

    try {
      const appiumConfigPath = _path.default.resolve(__dirname, '..', '..', '.appiumconfig.json');

      if (await _support.fs.exists(appiumConfigPath)) {
        jsonobj = JSON.parse(await _support.fs.readFile(appiumConfigPath, 'utf8'));
      }
    } catch (err) {
      _logger.default.debug(err);

      return null;
    }

    if (jsonobj && jsonobj.node_bin && (await _support.fs.exists(jsonobj.node_bin))) {
      _logger.default.debug(`Node binary found using .appiumconfig.json at: ${jsonobj.node_bin}`);

      return jsonobj.node_bin;
    } else {
      _logger.default.debug('Node binary not found in the .appiumconfig.json file.');

      return null;
    }
  }

  static async detect() {
    let nodePath = (await NodeDetector.retrieveUsingSystemCall()) || (await NodeDetector.retrieveInCommonPlaces()) || (await NodeDetector.retrieveUsingAppleScript()) || (await NodeDetector.retrieveUsingAppiumConfigFile());

    if (nodePath) {
      return nodePath;
    } else {
      _logger.default.warn('The node binary could not be found.');

      return null;
    }
  }

}

var _default = NodeDetector;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOT0RFX0NPTU1PTl9QQVRIUyIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0JJTiIsIk5vZGVEZXRlY3RvciIsInJldHJpZXZlSW5Db21tb25QbGFjZXMiLCJwIiwiZnMiLCJleGlzdHMiLCJsb2ciLCJkZWJ1ZyIsInJldHJpZXZlVXNpbmdTeXN0ZW1DYWxsIiwibm9kZVBhdGgiLCJyZXNvbHZlRXhlY3V0YWJsZVBhdGgiLCJQQVRIIiwicmV0cmlldmVVc2luZ0FwcGxlU2NyaXB0Iiwic3lzdGVtIiwiaXNNYWMiLCJhcHBTY3JpcHQiLCJqb2luIiwic3Rkb3V0IiwiZXhlYyIsImVyciIsInJlcGxhY2UiLCJyZXRyaWV2ZVVzaW5nQXBwaXVtQ29uZmlnRmlsZSIsImpzb25vYmoiLCJhcHBpdW1Db25maWdQYXRoIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZSIsIm5vZGVfYmluIiwiZGV0ZWN0Iiwid2FybiJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9ub2RlLWRldGVjdG9yLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7ZnMsIHN5c3RlbX0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7ZXhlY30gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQge3Jlc29sdmVFeGVjdXRhYmxlUGF0aH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IE5PREVfQ09NTU9OX1BBVEhTID0gW3Byb2Nlc3MuZW52Lk5PREVfQklOLCAnL3Vzci9sb2NhbC9iaW4vbm9kZScsICcvb3B0L2xvY2FsL2Jpbi9ub2RlJ107XG5cbi8vIExvb2sgZm9yIG5vZGVcbmNsYXNzIE5vZGVEZXRlY3RvciB7XG4gIHN0YXRpYyBhc3luYyByZXRyaWV2ZUluQ29tbW9uUGxhY2VzKCkge1xuICAgIGZvciAobGV0IHAgb2YgTk9ERV9DT01NT05fUEFUSFMpIHtcbiAgICAgIGlmIChwICYmIChhd2FpdCBmcy5leGlzdHMocCkpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgTm9kZSBiaW5hcnkgZm91bmQgYXQgY29tbW9uIHBsYWNlOiAke3B9YCk7XG4gICAgICAgIHJldHVybiBwO1xuICAgICAgfVxuICAgIH1cbiAgICBsb2cuZGVidWcoXCJOb2RlIGJpbmFyeSB3YXNuJ3QgZm91bmQgYXQgY29tbW9uIHBsYWNlcy5cIik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgcmV0cmlldmVVc2luZ1N5c3RlbUNhbGwoKSB7XG4gICAgY29uc3Qgbm9kZVBhdGggPSBhd2FpdCByZXNvbHZlRXhlY3V0YWJsZVBhdGgoJ25vZGUnKTtcblxuICAgIGlmICghbm9kZVBhdGgpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgTm9kZSBiaW5hcnkgbm90IGZvdW5kIGluIFBBVEg6ICR7cHJvY2Vzcy5lbnYuUEFUSH1gKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZyhgTm9kZSBiaW5hcnkgZm91bmQgYXQ6ICR7bm9kZVBhdGh9YCk7XG4gICAgcmV0dXJuIG5vZGVQYXRoO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIHJldHJpZXZlVXNpbmdBcHBsZVNjcmlwdCgpIHtcbiAgICBpZiAoIXN5c3RlbS5pc01hYygpKSB7XG4gICAgICBsb2cuZGVidWcoJ05vdCBvbiBEYXJ3aW4sIHNraXBwaW5nIEFwcGxlIFNjcmlwdCcpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgYXBwU2NyaXB0ID0gW1xuICAgICAgJ3RyeScsXG4gICAgICAnICBzZXQgYXBwaXVtSXNSdW5uaW5nIHRvIGZhbHNlJyxcbiAgICAgICcgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCInLFxuICAgICAgJyAgICBzZXQgYXBwaXVtSXNSdW5uaW5nIHRvIG5hbWUgb2YgZXZlcnkgcHJvY2VzcyBjb250YWlucyBcIkFwcGl1bVwiJyxcbiAgICAgICcgIGVuZCB0ZWxsJyxcbiAgICAgICcgIGlmIGFwcGl1bUlzUnVubmluZyB0aGVuJyxcbiAgICAgICcgICAgdGVsbCBhcHBsaWNhdGlvbiBcIkFwcGl1bVwiIHRvIHJldHVybiBub2RlIHBhdGgnLFxuICAgICAgJyAgZW5kIGlmJyxcbiAgICAgICdlbmQgdHJ5JyxcbiAgICAgICdyZXR1cm4gXCJOVUxMXCInLFxuICAgIF0uam9pbignXFxuJyk7XG4gICAgbGV0IHN0ZG91dDtcbiAgICB0cnkge1xuICAgICAgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoJ29zYXNjcmlwdCcsIFsnLWUnLCBhcHBTY3JpcHRdKSkuc3Rkb3V0O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGVycik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgbGV0IG5vZGVQYXRoID0gc3Rkb3V0LnJlcGxhY2UoJ1xcbicsICcnKTtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKG5vZGVQYXRoKSkge1xuICAgICAgbG9nLmRlYnVnKGBOb2RlIGJpbmFyeSBmb3VuZCB1c2luZyBBcHBsZVNjcmlwdCBhdDogJHtub2RlUGF0aH1gKTtcbiAgICAgIHJldHVybiBub2RlUGF0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdOb2RlIGJpbmFyeSBub3QgZm91bmQgdXNpbmcgQXBwbGVTY3JpcHQuJyk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgcmV0cmlldmVVc2luZ0FwcGl1bUNvbmZpZ0ZpbGUoKSB7XG4gICAgbGV0IGpzb25vYmo7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwcGl1bUNvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLmFwcGl1bWNvbmZpZy5qc29uJyk7XG4gICAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKGFwcGl1bUNvbmZpZ1BhdGgpKSB7XG4gICAgICAgIGpzb25vYmogPSBKU09OLnBhcnNlKGF3YWl0IGZzLnJlYWRGaWxlKGFwcGl1bUNvbmZpZ1BhdGgsICd1dGY4JykpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGVycik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgaWYgKGpzb25vYmogJiYganNvbm9iai5ub2RlX2JpbiAmJiAoYXdhaXQgZnMuZXhpc3RzKGpzb25vYmoubm9kZV9iaW4pKSkge1xuICAgICAgbG9nLmRlYnVnKGBOb2RlIGJpbmFyeSBmb3VuZCB1c2luZyAuYXBwaXVtY29uZmlnLmpzb24gYXQ6ICR7anNvbm9iai5ub2RlX2Jpbn1gKTtcbiAgICAgIHJldHVybiBqc29ub2JqLm5vZGVfYmluO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ05vZGUgYmluYXJ5IG5vdCBmb3VuZCBpbiB0aGUgLmFwcGl1bWNvbmZpZy5qc29uIGZpbGUuJyk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgZGV0ZWN0KCkge1xuICAgIGxldCBub2RlUGF0aCA9XG4gICAgICAoYXdhaXQgTm9kZURldGVjdG9yLnJldHJpZXZlVXNpbmdTeXN0ZW1DYWxsKCkpIHx8XG4gICAgICAoYXdhaXQgTm9kZURldGVjdG9yLnJldHJpZXZlSW5Db21tb25QbGFjZXMoKSkgfHxcbiAgICAgIChhd2FpdCBOb2RlRGV0ZWN0b3IucmV0cmlldmVVc2luZ0FwcGxlU2NyaXB0KCkpIHx8XG4gICAgICAoYXdhaXQgTm9kZURldGVjdG9yLnJldHJpZXZlVXNpbmdBcHBpdW1Db25maWdGaWxlKCkpO1xuICAgIGlmIChub2RlUGF0aCkge1xuICAgICAgcmV0dXJuIG5vZGVQYXRoO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cud2FybignVGhlIG5vZGUgYmluYXJ5IGNvdWxkIG5vdCBiZSBmb3VuZC4nKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAg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