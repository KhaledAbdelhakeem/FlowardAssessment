"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.OptionalMjpegConsumerCommandCheck = exports.OptionalFfmpegCommandCheck = exports.NodeVersionCheck = exports.NodeBinaryCheck = void 0;

require("source-map-support/register");

var _utils = require("./utils");

var _teen_process = require("teen_process");

var _doctor = require("./doctor");

var _nodeDetector = _interopRequireDefault(require("./node-detector"));

var _support = require("@appium/support");

var _os = require("os");

require("@colors/colors");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let checks = [];

class NodeBinaryCheck extends _doctor.DoctorCheck {
  async diagnose() {
    let nodePath = await _nodeDetector.default.detect();
    return nodePath ? (0, _utils.ok)(`The Node.js binary was found at: ${nodePath}`) : (0, _utils.nok)('The Node.js binary was NOT found!');
  }

  fix() {
    return `Manually setup ${'Node.js'.bold}.`;
  }

}

exports.NodeBinaryCheck = NodeBinaryCheck;
checks.push(new NodeBinaryCheck());
const REQUIRED_NODE_VERSION = '10.0.0';

class NodeVersionCheck extends _doctor.DoctorCheck {
  async diagnose() {
    let nodePath = await _nodeDetector.default.detect();

    if (!nodePath) {
      return (0, _utils.nok)('Node is not installed, so no version to check!');
    }

    let {
      stdout
    } = await (0, _teen_process.exec)(nodePath, ['--version']);
    let versionString = stdout.replace('v', '').trim();

    try {
      return _support.util.compareVersions(REQUIRED_NODE_VERSION, '<=', versionString) ? (0, _utils.ok)(`Node version is ${versionString}`) : (0, _utils.nok)(`Node version should be at least ${REQUIRED_NODE_VERSION}!`);
    } catch {
      return (0, _utils.nok)(`Unable to find node version (version = '${versionString}')`);
    }
  }

  fix() {
    return `Manually upgrade ${'Node.js'.bold}.`;
  }

}

exports.NodeVersionCheck = NodeVersionCheck;
checks.push(new NodeVersionCheck());

class OptionalFfmpegCommandCheck extends _doctor.DoctorCheck {
  async diagnose() {
    const ffmpegPath = await (0, _utils.resolveExecutablePath)('ffmpeg');
    return ffmpegPath ? (0, _utils.okOptional)(`ffmpeg is installed at: ${ffmpegPath}. ${(await (0, _teen_process.exec)('ffmpeg', ['-version'])).stdout.split(_os.EOL)[0]}`) : (0, _utils.nokOptional)('ffmpeg cannot be found');
  }

  async fix() {
    return `${'ffmpeg'.bold} is needed to record screen features. Please read https://www.ffmpeg.org/ to install it`;
  }

}

exports.OptionalFfmpegCommandCheck = OptionalFfmpegCommandCheck;
checks.push(new OptionalFfmpegCommandCheck());

class OptionalMjpegConsumerCommandCheck extends _doctor.DoctorCheck {
  async diagnose() {
    const packageName = 'mjpeg-consumer';
    const packageInfo = await (0, _utils.getNpmPackageInfo)(packageName);

    if (packageInfo) {
      return (0, _utils.okOptional)(`${packageName} is installed at: ${packageInfo.path}. Installed version is: ${packageInfo.version}`);
    }

    return (0, _utils.nokOptional)(`${packageName} cannot be found.`);
  }

  async fix() {
    return `${'mjpeg-consumer'.bold} module is required to use MJPEG-over-HTTP features. Please install it with 'npm i -g mjpeg-consumer'.`;
  }

}

exports.OptionalMjpegConsumerCommandCheck = OptionalMjpegConsumerCommandCheck;
checks.push(new OptionalMjpegConsumerCommandCheck());
var _default = checks;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjaGVja3MiLCJOb2RlQmluYXJ5Q2hlY2siLCJEb2N0b3JDaGVjayIsImRpYWdub3NlIiwibm9kZVBhdGgiLCJOb2RlRGV0ZWN0b3IiLCJkZXRlY3QiLCJvayIsIm5vayIsImZpeCIsImJvbGQiLCJwdXNoIiwiUkVRVUlSRURfTk9ERV9WRVJTSU9OIiwiTm9kZVZlcnNpb25DaGVjayIsInN0ZG91dCIsImV4ZWMiLCJ2ZXJzaW9uU3RyaW5nIiwicmVwbGFjZSIsInRyaW0iLCJ1dGlsIiwiY29tcGFyZVZlcnNpb25zIiwiT3B0aW9uYWxGZm1wZWdDb21tYW5kQ2hlY2siLCJmZm1wZWdQYXRoIiwicmVzb2x2ZUV4ZWN1dGFibGVQYXRoIiwib2tPcHRpb25hbCIsInNwbGl0IiwiRU9MIiwibm9rT3B0aW9uYWwiLCJPcHRpb25hbE1qcGVnQ29uc3VtZXJDb21tYW5kQ2hlY2siLCJwYWNrYWdlTmFtZSIsInBhY2thZ2VJbmZvIiwiZ2V0TnBtUGFja2FnZUluZm8iLCJwYXRoIiwidmVyc2lvbiJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9nZW5lcmFsLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7b2ssIG5vaywgb2tPcHRpb25hbCwgbm9rT3B0aW9uYWwsIHJlc29sdmVFeGVjdXRhYmxlUGF0aCwgZ2V0TnBtUGFja2FnZUluZm99IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHtleGVjfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHtEb2N0b3JDaGVja30gZnJvbSAnLi9kb2N0b3InO1xuaW1wb3J0IE5vZGVEZXRlY3RvciBmcm9tICcuL25vZGUtZGV0ZWN0b3InO1xuaW1wb3J0IHt1dGlsfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHtFT0x9IGZyb20gJ29zJztcbmltcG9ydCAnQGNvbG9ycy9jb2xvcnMnO1xuXG5sZXQgY2hlY2tzID0gW107XG5cbi8vIE5vZGUgQmluYXJ5XG5jbGFzcyBOb2RlQmluYXJ5Q2hlY2sgZXh0ZW5kcyBEb2N0b3JDaGVjayB7XG4gIGFzeW5jIGRpYWdub3NlKCkge1xuICAgIGxldCBub2RlUGF0aCA9IGF3YWl0IE5vZGVEZXRlY3Rvci5kZXRlY3QoKTtcbiAgICByZXR1cm4gbm9kZVBhdGhcbiAgICAgID8gb2soYFRoZSBOb2RlLmpzIGJpbmFyeSB3YXMgZm91bmQgYXQ6ICR7bm9kZVBhdGh9YClcbiAgICAgIDogbm9rKCdUaGUgTm9kZS5qcyBiaW5hcnkgd2FzIE5PVCBmb3VuZCEnKTtcbiAgfVxuXG4gIGZpeCgpIHtcbiAgICByZXR1cm4gYE1hbnVhbGx5IHNldHVwICR7J05vZGUuanMnLmJvbGR9LmA7XG4gIH1cbn1cbmNoZWNrcy5wdXNoKG5ldyBOb2RlQmluYXJ5Q2hlY2soKSk7XG5cbmNvbnN0IFJFUVVJUkVEX05PREVfVkVSU0lPTiA9ICcxMC4wLjAnO1xuXG4vLyBOb2RlIHZlcnNpb25cbmNsYXNzIE5vZGVWZXJzaW9uQ2hlY2sgZXh0ZW5kcyBEb2N0b3JDaGVjayB7XG4gIGFzeW5jIGRpYWdub3NlKCkge1xuICAgIGxldCBub2RlUGF0aCA9IGF3YWl0IE5vZGVEZXRlY3Rvci5kZXRlY3QoKTtcbiAgICBpZiAoIW5vZGVQYXRoKSB7XG4gICAgICByZXR1cm4gbm9rKCdOb2RlIGlzIG5vdCBpbnN0YWxsZWQsIHNvIG5vIHZlcnNpb24gdG8gY2hlY2shJyk7XG4gICAgfVxuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMobm9kZVBhdGgsIFsnLS12ZXJzaW9uJ10pO1xuICAgIGxldCB2ZXJzaW9uU3RyaW5nID0gc3Rkb3V0LnJlcGxhY2UoJ3YnLCAnJykudHJpbSgpO1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gdXRpbC5jb21wYXJlVmVyc2lvbnMoUkVRVUlSRURfTk9ERV9WRVJTSU9OLCAnPD0nLCB2ZXJzaW9uU3RyaW5nKVxuICAgICAgICA/IG9rKGBOb2RlIHZlcnNpb24gaXMgJHt2ZXJzaW9uU3RyaW5nfWApXG4gICAgICAgIDogbm9rKGBOb2RlIHZlcnNpb24gc2hvdWxkIGJlIGF0IGxlYXN0ICR7UkVRVUlSRURfTk9ERV9WRVJTSU9OfSFgKTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiBub2soYFVuYWJsZSB0byBmaW5kIG5vZGUgdmVyc2lvbiAodmVyc2lvbiA9ICcke3ZlcnNpb25TdHJpbmd9JylgKTtcbiAgICB9XG4gIH1cblxuICBmaXgoKSB7XG4gICAgcmV0dXJuIGBNYW51YWxseSB1cGdyYWRlICR7J05vZGUuanMnLmJvbGR9LmA7XG4gIH1cbn1cbmNoZWNrcy5wdXNoKG5ldyBOb2RlVmVyc2lvbkNoZWNrKCkpO1xuXG5jbGFzcyBPcHRpb25hbEZmbXBlZ0NvbW1hbmRDaGVjayBleHRlbmRzIERvY3RvckNoZWNrIHtcbiAgYXN5bmMgZGlhZ25vc2UoKSB7XG4gICAgY29uc3QgZmZtcGVnUGF0aCA9IGF3YWl0IHJlc29sdmVFeGVjdXRhYmxlUGF0aCgnZmZtcGVnJyk7XG4gICAgcmV0dXJuIGZmbXBlZ1BhdGhcbiAgICAgID8gb2tPcHRpb25hbChcbiAgICAgICAgICBgZmZtcGVnIGlzIGluc3RhbGxlZCBhdDogJHtmZm1wZWdQYXRofS4gJHtcbiAgICAgICAgICAgIChhd2FpdCBleGVjKCdmZm1wZWcnLCBbJy12ZXJzaW9uJ10pKS5zdGRvdXQuc3BsaXQoRU9MKVswXVxuICAgICAgICAgIH1gXG4gICAgICAgIClcbiAgICAgIDogbm9rT3B0aW9uYWwoJ2ZmbXBlZyBjYW5ub3QgYmUgZm91bmQnKTtcbiAgfVxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVxdWlyZS1hd2FpdFxuICBhc3luYyBmaXgoKSB7XG4gICAgcmV0dXJuIGAke1xuICAgICAgJ2ZmbXBlZycuYm9sZFxuICAgIH0gaXMgbmVlZGVkIHRvIHJlY29yZCBzY3JlZW4gZmVhdHVyZXMuIFBsZWFzZSByZWFkIGh0dHBzOi8vd3d3LmZmbXBlZy5vcmcvIHRvIGluc3RhbGwgaXRgO1xuICB9XG59XG5jaGVja3MucHVzaChuZXcgT3B0aW9uYWxGZm1wZWdDb21tYW5kQ2hlY2soKSk7XG5cbmNsYXNzIE9wdGlvbmFsTWpwZWdDb25zdW1lckNvbW1hbmRDaGVjayBleHRlbmRzIERvY3RvckNoZWNrIHtcbiAgYXN5bmMgZGlhZ25vc2UoKSB7XG4gICAgY29uc3QgcGFja2FnZU5hbWUgPSAnbWpwZWctY29uc3VtZXInO1xuICAgIGNvbnN0IHBhY2thZ2VJbmZvID0gYXdhaXQgZ2V0TnBtUGFja2FnZUluZm8ocGFja2FnZU5hbWUpO1xuXG4gICAgaWYgKHBhY2thZ2VJbmZvKSB7XG4gICAgICByZXR1cm4gb2tPcHRpb25hbChcbiAgICAgICAgYCR7cGFja2FnZU5hbWV9IGlzIGluc3RhbGxlZCBhdDogJHtwYWNrYWdlSW5mby5wYXRofS4gSW5zdGFsbGVkIHZlcnNpb24gaXM6ICR7cGFja2FnZUluZm8udmVyc2lvbn1gXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gbm9rT3B0aW9uYWwoYCR7cGFja2FnZU5hbWV9IGNhbm5vdCBiZSBmb3VuZC5gKTtcbiAgfVxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVxdWlyZS1hd2FpdFxuICBhc3luYyBmaXgoKSB7XG4gICAgcmV0dXJuIGAke1xuICAgICAgJ21qcGVnLWNvbnN1bWVyJy5ib2xkXG4gICAgfSBtb2R1bGUgaXMgcmVxdWlyZWQgdG8gdXNlIE1KUEVHLW92ZXItSFRUUCBmZWF0dXJlcy4gUGxlYXNlIGluc3RhbGwgaXQgd2l0aCAnbnBtIGkgLWcgbWpwZWctY29uc3VtZXInLmA7XG4gIH1cbn1cbmNoZWNrcy5wdXNoKG5ldyBPcHRpb25hbE1qcGVnQ29uc3VtZXJDb21tYW5kQ2hlY2soKSk7XG5cbmV4cG9ydCB7XG4gIE5vZGVCaW5hcnlDaGVjayxcbiAgTm9kZVZlcnNpb25DaGVjayxcbiAgT3B0aW9uYWxGZm1wZWdDb21tYW5kQ2hlY2ssXG4gIE9wdGlvbmFsTWpwZWdDb25zdW1lckNvbW1hbmRDaGVjayxcbn07XG5leHBvcnQgZGVmYXVsdCBjaGVja3M7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsSUFBSUEsTUFBTSxHQUFHLEVBQWI7O0FBR0EsTUFBTUMsZUFBTixTQUE4QkMsbUJBQTlCLENBQTBDO0VBQzFCLE1BQVJDLFFBQVEsR0FBRztJQUNmLElBQUlDLFFBQVEsR0FBRyxNQUFNQyxxQkFBQSxDQUFhQyxNQUFiLEVBQXJCO0lBQ0EsT0FBT0YsUUFBUSxHQUNYLElBQUFHLFNBQUEsRUFBSSxvQ0FBbUNILFFBQVMsRUFBaEQsQ0FEVyxHQUVYLElBQUFJLFVBQUEsRUFBSSxtQ0FBSixDQUZKO0VBR0Q7O0VBRURDLEdBQUcsR0FBRztJQUNKLE9BQVEsa0JBQWlCLFVBQVVDLElBQUssR0FBeEM7RUFDRDs7QUFWdUM7OztBQVkxQ1YsTUFBTSxDQUFDVyxJQUFQLENBQVksSUFBSVYsZUFBSixFQUFaO0FBRUEsTUFBTVcscUJBQXFCLEdBQUcsUUFBOUI7O0FBR0EsTUFBTUMsZ0JBQU4sU0FBK0JYLG1CQUEvQixDQUEyQztFQUMzQixNQUFSQyxRQUFRLEdBQUc7SUFDZixJQUFJQyxRQUFRLEdBQUcsTUFBTUMscUJBQUEsQ0FBYUMsTUFBYixFQUFyQjs7SUFDQSxJQUFJLENBQUNGLFFBQUwsRUFBZTtNQUNiLE9BQU8sSUFBQUksVUFBQSxFQUFJLGdEQUFKLENBQVA7SUFDRDs7SUFDRCxJQUFJO01BQUNNO0lBQUQsSUFBVyxNQUFNLElBQUFDLGtCQUFBLEVBQUtYLFFBQUwsRUFBZSxDQUFDLFdBQUQsQ0FBZixDQUFyQjtJQUNBLElBQUlZLGFBQWEsR0FBR0YsTUFBTSxDQUFDRyxPQUFQLENBQWUsR0FBZixFQUFvQixFQUFwQixFQUF3QkMsSUFBeEIsRUFBcEI7O0lBQ0EsSUFBSTtNQUNGLE9BQU9DLGFBQUEsQ0FBS0MsZUFBTCxDQUFxQlIscUJBQXJCLEVBQTRDLElBQTVDLEVBQWtESSxhQUFsRCxJQUNILElBQUFULFNBQUEsRUFBSSxtQkFBa0JTLGFBQWMsRUFBcEMsQ0FERyxHQUVILElBQUFSLFVBQUEsRUFBSyxtQ0FBa0NJLHFCQUFzQixHQUE3RCxDQUZKO0lBR0QsQ0FKRCxDQUlFLE1BQU07TUFDTixPQUFPLElBQUFKLFVBQUEsRUFBSywyQ0FBMENRLGFBQWMsSUFBN0QsQ0FBUDtJQUNEO0VBQ0Y7O0VBRURQLEdBQUcsR0FBRztJQUNKLE9BQVEsb0JBQW1CLFVBQVVDLElBQUssR0FBMUM7RUFDRDs7QUFuQndDOzs7QUFxQjNDVixNQUFNLENBQUNXLElBQVAsQ0FBWSxJQUFJRSxnQkFBSixFQUFaOztBQUVBLE1BQU1RLDBCQUFOLFNBQXlDbkIsbUJBQXpDLENBQXFEO0VBQ3JDLE1BQVJDLFFBQVEsR0FBRztJQUNmLE1BQU1tQixVQUFVLEdBQUcsTUFBTSxJQUFBQyw0QkFBQSxFQUFzQixRQUF0QixDQUF6QjtJQUNBLE9BQU9ELFVBQVUsR0FDYixJQUFBRSxpQkFBQSxFQUNHLDJCQUEwQkYsVUFBVyxLQUNwQyxDQUFDLE1BQU0sSUFBQVAsa0JBQUEsRUFBSyxRQUFMLEVBQWUsQ0FBQyxVQUFELENBQWYsQ0FBUCxFQUFxQ0QsTUFBckMsQ0FBNENXLEtBQTVDLENBQWtEQyxPQUFsRCxFQUF1RCxDQUF2RCxDQUNELEVBSEgsQ0FEYSxHQU1iLElBQUFDLGtCQUFBLEVBQVksd0JBQVosQ0FOSjtFQU9EOztFQUVRLE1BQUhsQixHQUFHLEdBQUc7SUFDVixPQUFRLEdBQ04sU0FBU0MsSUFDVix5RkFGRDtFQUdEOztBQWhCa0Q7OztBQWtCckRWLE1BQU0sQ0FBQ1csSUFBUCxDQUFZLElBQUlVLDBCQUFKLEVBQVo7O0FBRUEsTUFBTU8saUNBQU4sU0FBZ0QxQixtQkFBaEQsQ0FBNEQ7RUFDNUMsTUFBUkMsUUFBUSxHQUFHO0lBQ2YsTUFBTTBCLFdBQVcsR0FBRyxnQkFBcEI7SUFDQSxNQUFNQyxXQUFXLEdBQUcsTUFBTSxJQUFBQyx3QkFBQSxFQUFrQkYsV0FBbEIsQ0FBMUI7O0lBRUEsSUFBSUMsV0FBSixFQUFpQjtNQUNmLE9BQU8sSUFBQU4saUJBQUEsRUFDSixHQUFFSyxXQUFZLHFCQUFvQkMsV0FBVyxDQUFDRSxJQUFLLDJCQUEwQkYsV0FBVyxDQUFDRyxPQUFRLEVBRDdGLENBQVA7SUFHRDs7SUFDRCxPQUFPLElBQUFOLGtCQUFBLEVBQWEsR0FBRUUsV0FBWSxtQkFBM0IsQ0FBUDtFQUNEOztFQUVRLE1BQUhwQixHQUFHLEdBQUc7SUFDVixPQUFRLEdBQ04saUJBQWlCQyxJQUNsQix3R0FGRDtFQUdEOztBQWpCeUQ7OztBQW1CNURWLE1BQU0sQ0FBQ1csSUFBUCxDQUFZLElBQUlpQixpQ0FBSixFQUFaO2VBUWU1QixNIn0=