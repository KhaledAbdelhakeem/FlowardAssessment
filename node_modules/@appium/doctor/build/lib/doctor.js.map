{"version":3,"file":"doctor.js","names":["version","fs","readPackageJsonFrom","__dirname","FixSkippedError","Error","DoctorCheck","constructor","opts","autofix","diagnose","fix","Doctor","checks","checkOptionals","toFix","toFixOptionals","register","Array","isArray","concat","log","info","green","check","res","optional","push","diagnosticResultMessage","fixMessage","length","yellow","checkOptional","reportManualFixes","fixOptioal","manualFixes","_","filter","f","manualFixesOptional","fixMessages","m","uniq","warn","runAutoFix","error","err","replace","ok","fixed","message","red","runAutoFixes","autoFixes","find","run","reportSuccess","result","toFixList","errorMessage","lengthOptional"],"sources":["../../lib/doctor.js"],"sourcesContent":["import '@colors/colors';\nimport _ from 'lodash';\nimport log from './logger';\nimport {fs} from '@appium/support';\n\nconst {version} = fs.readPackageJsonFrom(__dirname);\n\nclass FixSkippedError extends Error {}\n\nclass DoctorCheck {\n  constructor(opts = {}) {\n    this.autofix = !!opts.autofix;\n  }\n\n  diagnose() {\n    throw new Error('Not Implemented!');\n  }\n\n  fix() {\n    // return string for manual fixes.\n    throw new Error('Not Implemented!');\n  }\n}\n\nclass Doctor {\n  constructor() {\n    this.checks = [];\n    this.checkOptionals = [];\n    this.toFix = [];\n    this.toFixOptionals = [];\n  }\n\n  register(checks) {\n    checks = Array.isArray(checks) ? checks : [checks];\n    this.checks = this.checks.concat(checks);\n  }\n\n  async diagnose() {\n    log.info(`### Diagnostic for ${'necessary'.green} dependencies starting ###`);\n    this.toFix = [];\n    for (const check of this.checks) {\n      const res = await check.diagnose();\n      if (res.optional) {\n        this.checkOptionals.push(check);\n        continue;\n      }\n      await this.diagnosticResultMessage(res, this.toFix, check);\n    }\n    log.info(\n      `### Diagnostic for necessary dependencies completed, ${await this.fixMessage(\n        this.toFix.length\n      )}. ###`\n    );\n    log.info('');\n\n    log.info(`### Diagnostic for ${'optional'.yellow} dependencies starting ###`);\n    this.toFixOptionals = [];\n    for (const checkOptional of this.checkOptionals) {\n      await this.diagnosticResultMessage(\n        await checkOptional.diagnose(),\n        this.toFixOptionals,\n        checkOptional\n      );\n    }\n    log.info(\n      `### Diagnostic for optional dependencies completed, ${await this.fixMessage(\n        this.toFixOptionals.length,\n        true\n      )}. ###`\n    );\n    log.info('');\n  }\n\n  async reportManualFixes(fix, fixOptioal) {\n    const manualFixes = _.filter(fix, (f) => !f?.check?.autofix);\n    const manualFixesOptional = _.filter(fixOptioal, (f) => !f?.check?.autofix);\n\n    if (manualFixes.length > 0) {\n      log.info('### Manual Fixes Needed ###');\n      log.info('The configuration cannot be automatically fixed, please do the following first:');\n      // for manual fixes, the fix method always return a string\n      const fixMessages = [];\n      for (const f of manualFixes) {\n        fixMessages.push(await f.check.fix());\n      }\n      for (const m of _.uniq(fixMessages)) {\n        log.warn(` \\u279C ${m}`);\n      }\n      log.info('');\n    }\n    if (manualFixesOptional.length > 0) {\n      log.info('### Optional Manual Fixes ###');\n      log.info('The configuration can install optionally. Please do the following manually:');\n      // for manual fixes, the fix method always return a string\n      const fixMessages = [];\n      for (const f of manualFixesOptional) {\n        fixMessages.push(await f.check.fix());\n      }\n      for (const m of _.uniq(fixMessages)) {\n        log.warn(` \\u279C ${m}`);\n      }\n      log.info('');\n    }\n\n    if (manualFixes.length > 0 || manualFixesOptional.length > 0) {\n      log.info('###');\n      log.info('');\n      log.info('Bye! Run appium-doctor again when all manual fixes have been applied!');\n      log.info('');\n      return true;\n    }\n    return false;\n  }\n\n  async runAutoFix(f) {\n    log.info(`### Fixing: ${f.error} ###`);\n    try {\n      await f.check.fix();\n    } catch (err) {\n      if (err instanceof FixSkippedError) {\n        log.info(`### Skipped fix ###`);\n        return;\n      } else {\n        log.warn(`${err}`.replace(/\\n$/g, ''));\n        log.info(`### Fix did not succeed ###`);\n        return;\n      }\n    }\n    log.info('Checking if this was fixed:');\n    let res = await f.check.diagnose();\n    if (res.ok) {\n      f.fixed = true;\n      log.info(` ${'\\u2714'.green} ${res.message}`);\n      log.info(`### Fix was successfully applied ###`);\n    } else {\n      log.info(` ${'\\u2716'.red} ${res.message}`);\n      log.info(`### Fix was applied but issue remains ###`);\n    }\n  }\n\n  async runAutoFixes() {\n    let autoFixes = _.filter(this.toFix, (f) => f?.check?.autofix);\n    for (let f of autoFixes) {\n      await this.runAutoFix(f);\n      log.info('');\n    }\n    if (_.find(autoFixes, (f) => !f.fixed)) {\n      // a few issues remain.\n      log.info('Bye! A few issues remain, fix manually and/or rerun appium-doctor!');\n    } else {\n      // nothing left to fix.\n      log.info('Bye! All issues have been fixed!');\n    }\n    log.info('');\n  }\n\n  async run() {\n    log.info(`Appium Doctor v.${version}`);\n    await this.diagnose();\n    if (await this.reportSuccess(this.toFix.length, this.toFixOptionals.length)) {\n      return;\n    }\n    if (await this.reportManualFixes(this.toFix, this.toFixOptionals)) {\n      return;\n    }\n    await this.runAutoFixes();\n  }\n\n  //// generating messages\n  // eslint-disable-next-line require-await\n  async diagnosticResultMessage(result, toFixList, check) {\n    if (result.ok) {\n      log.info(` ${'\\u2714'.green} ${result.message}`);\n    } else {\n      const errorMessage = result.optional\n        ? ` ${'\\u2716'.yellow} ${result.message}`\n        : ` ${'\\u2716'.red} ${result.message}`;\n      log.warn(errorMessage);\n      toFixList.push({\n        error: errorMessage,\n        check,\n      });\n    }\n  }\n\n  // eslint-disable-next-line require-await\n  async fixMessage(length, optional = false) {\n    let message;\n    switch (length) {\n      case 0:\n        message = 'no fix';\n        break;\n      case 1:\n        message = 'one fix';\n        break;\n      default:\n        message = `${length} fixes`;\n    }\n    return `${message} ${optional ? 'possible' : 'needed'}`;\n  }\n  // eslint-disable-next-line require-await\n  async reportSuccess(length, lengthOptional) {\n    if (length === 0 && lengthOptional === 0) {\n      log.info('Everything looks good, bye!');\n      log.info('');\n      return true;\n    } else {\n      return false;\n    }\n  }\n}\n\nexport {Doctor, DoctorCheck, FixSkippedError};\n"],"mappings":"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"}